<div style="height:100%">
    <h2>Images</h2>
    <div id="file-browser" style="height:calc(100% - 75px);"></div>
</div>
<link rel="stylesheet" href="/static/dataAdmin/css/imageBrowser.css" />
<script src="/static/dataAdmin/js/imageBrowser.js"></script>
<script type="text/javascript">

    function refreshTable() {
        var table = $('#images-table-body');

        //TODO: parse filter parameters
        params = {limit: 10};

        return $.ajax({
            url: window.dataServerURI + '{{ project }}' + '/listImages',
            method: 'POST',
            data: JSON.stringify(params),
            contentType: 'application/json; charset=utf-8',
            dataType: 'json',
            success: function(data) {
                // assemble table
                data = data['response'];
                
                images = [];
                for(var idx=0; idx<data.length; idx++) {
                    var id = data[idx]['id'];
                    var dateAdded = '';
                    if(data[idx]['date_added'] != undefined && data[idx]['date_added'] != null) {
                        var dateAdded = new Date(data[idx]['date_added']*1000 - 1).toLocaleString();
                    }
                    var lastViewed = '';
                    if(data[idx]['last_viewed'] != undefined && data[idx]['last_viewed'] != null) {
                        var lastViewed = new Date(data[idx]['last_viewed']*1000 - 1).toLocaleString();
                    }
                    images.push({
                        'id': data[idx]['id'],
                        'url': data[idx]['filename'],
                        'date_added': dateAdded,
                        'last_viewed': lastViewed,
                        'num_anno': data[idx]['num_anno'],
                        'num_pred': data[idx]['num_pred']
                    });
                }

                var fileBrowserDiv = $('#file-browser');

                //TODO: /files/ ?
                fb = new ImageBrowser(fileBrowserDiv, {
                    'baseURL': window.dataServerURI + '{{ project }}/files/',
                    'images': images,
                    'showCheckboxes': true,
                    'showImages': true,
                    'colnames': [
                        {'url': 'File'},
                        {'date_added': 'Added'},
                        {'last_viewed': 'Last viewed'},
                        {'num_anno': '# Anno'},
                        {'num_pred': '# Pred'}
                    ]
                });
            },
            error: function(data) {
                console.log('ERROR:');
                console.log(data);
            }
        })
    }

    $(document).ready(function() {

        // get data server URI
        var promise = $.get('{{ project }}/getProjectSettings', function(data) {
            window.dataServerURI = data['settings']['dataServerURI'];
            if(!window.dataServerURI.endsWith('/')) {
                window.dataServerURI += '/';
            }
        });

        promise = promise.done(function() {
            // load initial image data
            return refreshTable();
        });

        promise.done(function() {
            window.showLoadingOverlay(false);
        });
    });

</script>