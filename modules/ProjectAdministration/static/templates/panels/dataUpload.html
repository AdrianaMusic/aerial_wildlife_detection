<div>
    <h2>Data upload</h2>
    <div id="controls">
        <div id="upload-mode">
            <h3>Upload mode</h3>
            <fieldset id="upload-mode-select">
                <input type="radio" id="radio-browserupload" name="upload-mode-select" value="browserUpload" checked>
                <label for="radio-browserupload">Upload images</label><br />
                <input type="radio" id="radio-scandisk" name="upload-mode-select" value="scanDisk">
                <label for="radio-scandisk">Scan file server disk for untracked images</label>
            </fieldset>
        </div>
        <div id="actions-panel"></div>
    </div>
    <div id="image-browser"></div>
</div>
<link rel="stylesheet" href="/static/dataAdmin/css/imageBrowser.css" />
<style>
    #actions-panel {
        margin-bottom: 20px;
    }
</style>
<script src="/static/dataAdmin/js/imageBrowser.js"></script>
<script type="text/javascript">

    // untracked functions
    function scanUntracked() {
        window.imageBrowser.setLoadingOverlay(true, 'loading...');
        $.ajax({
            url: '{{ project }}/scanForImages',
            method: 'GET',
            success: function(data) {
                var imgs = [];
                for(var i=0; i<data['response'].length; i++) {
                    imgs.push({
                        url: data['response'][i]
                    });
                }
                
                window.untrackedFiles = imgs;

                // add them in chunks
                var chunk = window.untrackedFiles.splice(0, 100);
                window.imageBrowser.setImages(chunk);
                if(chunk.length < window.untrackedFiles.length) {
                    window.imageBrowser.setTrailingButton(true, false);
                }
                updateUntrackedCount();
                window.imageBrowser.setLoadingOverlay(false);
            },
            error: function(data) {
                console.error(data);    //TODO
                window.imageBrowser.setLoadingOverlay(false);
            }
        });
    }

    function updateUntrackedCount() {
        var numChecked = window.imageBrowser.getChecked().length;
        var numShown = window.imageBrowser.getNumEntries();
        var numTotal = numShown + window.untrackedFiles.length;

        $('#untracked-count').html(numChecked + ' images checked; ' +
                                numShown + ' shown, ' +
                                numTotal + ' total');
    }

    function showMoreUntracked() {
        if(window.untrackedFiles === undefined) return;
        var len = window.untrackedFiles.length;
        if(len === 0) {
            window.imageBrowser.setTrailingButton(false);
            return;
        }
        window.imageBrowser.addImages(window.untrackedFiles.splice(0, Math.min(100, len)));
        window.imageBrowser.setTrailingButton(true, false);
    }

    function _do_add_untracked(imgList) {
        if(imgList.length === 0) return;
        return $.ajax({
            url: '{{ project }}/addExistingImages',
            method: 'POST',
            data: JSON.stringify({images:imgList}),
            contentType: 'application/json; charset=utf-8',
            dataType: 'json',
            success: function(response) {
                console.log(response);  //TODO
                if(response['status'] === 0) {
                    // remove selected images from image browser
                    //TODO
                }
                updateUntrackedCount();
            },
            error: function(response) {
                console.error(response);    //TODO
                updateUntrackedCount();
            }
        });
    }

    function addSelectedUntracked() {
        var checked = window.imageBrowser.getChecked();
        var imgList = [];
        for(var key in checked) {
            imgList.push(checked[key].data['url']);
        }
        return _do_add_untracked(imgList);
    }

    function addAllUntracked() {
        if(window.untrackedFiles === undefined) return;
        var imgList = [];
        for(var key in window.imageBrowser.entries) {
            imgList.push(window.imageBrowser.entries[key].data['url']);
        }
        imgList = imgList.concat(window.untrackedFiles);
        return _do_add_untracked(imgList);
    }


    // upload functions
    function startUploadFilesFromDisk() {
        //TODO
        window.uploadedFiles = [];
        var formData = new FormData();
        var fileInput = $('#file-upload-select')[0];

        // filter files according to MIME type
        for(var i=0; i<fileInput.files.length; i++) {
            var nextItem = fileInput.files[i];
            if(window.validImageMIMEtypes.includes(nextItem.type)) {
                window.uploadedFiles.push(nextItem);
                formData.append('file-'+i, nextItem);
            }
        }

        // upload
        $.ajax({
            url: '{{ project }}/uploadImages',
            method: 'POST',
            data: formData,
            cache: false,
            contentType: false,
            processData: false,
            xhr: function () {
                var customXhr = $.ajaxSettings.xhr();
                if(customXhr.upload) {
                    customXhr.upload.addEventListener('progress', function (e) {
                    if (e.lengthComputable) {
                        //TODO
                        console.log(e);
                        // console.log(e.loaded + ', ' + e.total)
                        // $('progress').attr({
                        //     value: e.loaded,
                        //     max: e.total,
                        // });
                    }
                    }, false);
                }
                return customXhr;
            },
            success: function(data) {
                console.log(data);
            },
            error: function(data) {
                console.log(data);
            }
        })
    }



    // general functions
    function getSelectedMode() {
        return $('#upload-mode-select [name=upload-mode-select]:checked').val();
    }

    function onClickMore(event) {
        if(getSelectedMode() === 'browserUpload') {
            //TODO

        } else if(getSelectedMode() === 'scanDisk') {
            showMoreUntracked();
            //TODO: modify image browser trailing button to show number of images left
        }
    }


    function setImageBrowserSize() {
        var height = $('#contents').height() - $('#controls').outerHeight() -
                        $('.image-browser-view-buttons').outerHeight() - 60;    // -60 for header and margins
        $('.list-container').css('height', height);
        $('.thumbs-container').css('height', height);
    }


    $(document).ready(function() {

        // get data server URI
        var promise = $.get('{{ project }}/getProjectSettings', function(data) {
            window.dataServerURI = data['settings']['dataServerURI'];
            if(!window.dataServerURI.endsWith('/')) {
                window.dataServerURI += '/';
            }
        });

        // get valid image MIME types
        promise = promise.done(function() {
            return $.ajax({
                url: '/getValidMIMEtypes',
                method: 'GET',
                success: function(data) {
                    if(data.hasOwnProperty('MIME_types')) {
                        window.validImageMIMEtypes = data['MIME_types'];
                    } else {
                        window.validImageMIMEtypes = [];
                    }
                },
                error: function(data) {
                    //TODO
                    window.validImageMIMEtypes = [];
                }
            });
        });


        // setup
        promise = promise.done(function() {

            // setup image browser
            window.imageBrowser = new ImageBrowser($('#image-browser'), {
                'baseURL': window.dataServerURI + '{{ project }}/files/',
                'images': [],
                'showCheckboxes': true,
                'showImages': true,
                'colnames': [
                    {'url': 'File'}
                ]
            });

            window.imageBrowser.setTrailingButton(false,
                                                false,
                                                'more...',
                                                onClickMore);

            $(window).on('resize', function() {
                setImageBrowserSize();
            });

            // setup action panel markups
            window.actionPanel_scan = $('<div></div>');
            var infoMessage = $('<div></div>');
            infoMessage.append($('<div>You can manually upload your images to the file server and then import them to the database here.</div>'));
            infoMessage.append($('<ul><li>Server address: <span></span></li><li>Image folder: <span></span></li></ul>'));   //TODO
            window.actionPanel_scan.append(infoMessage);
            var scanUntrackedButton = $('<button id="scan-button" class="btn btn-sm btn-primary">Scan untracked</button>');
            scanUntrackedButton.on('click', function() {
                scanUntracked();
            });
            window.actionPanel_scan.append(scanUntrackedButton);
            var actionButtons = $('<div></div>');
            var checkCount = $('<div id="untracked-count"></div>');
            actionButtons.append(checkCount);
            var addChecked = $('<button class="btn btn-sm btn-success">Add checked</button>');
            addChecked.on('click', function() {
                addSelectedUntracked();
            });
            actionButtons.append(addChecked);
            var addAll = $('<button class="btn btn-sm btn-danger">Add all</button>');
            addAll.on('click', function() {
                addAllUntracked();
            });
            actionButtons.append(addAll);
            window.actionPanel_scan.append(actionButtons);


            window.actionPanel_upload = $('<div></div>');
            var fileUploadSelect = $('<input id="file-upload-select" type="file" webkitdirectory directory multiple />');
            window.actionPanel_upload.append(fileUploadSelect);
            var startFileUpload = $('<button class="btn btn-sm btn-primary">Upload</button>');
            startFileUpload.on('click', function() {
                startUploadFilesFromDisk();
            });
            window.actionPanel_upload.append(startFileUpload);

            $('#actions-panel').append(window.actionPanel_upload);
            $('#upload-mode-select input:radio').on('change', function() {
                if($(this).val() === 'browserUpload') {
                    window.actionPanel_scan.detach();
                    $('#actions-panel').append(window.actionPanel_upload);

                } else if($(this).val() === 'scanDisk') {
                    window.actionPanel_upload.detach();
                    $('#actions-panel').append(window.actionPanel_scan);
                }
                window.imageBrowser.setImages([]);
                window.untrackedFiles = undefined;
                setImageBrowserSize();
            });


            setImageBrowserSize();
            window.showLoadingOverlay(false);
        });
    });
</script>