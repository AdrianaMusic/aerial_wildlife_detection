<div>
    <div id="options-header" style="cursor:pointer">
        <!-- TODO: Triangle -->
        <h2>Options</h2>
    </div>
    <div id="options-container">
        <div class="tables-container">
            <div class="entity-table" style="width:70%;order:1;">
                <div>AI model to be evaluated:</div>
                <table>
                    <thead>
                        <tr>
                            <th><input type="checkbox" id="select-all-states" /></th>
                            <th>#</th>
                            <th>Time created</th>
                            <th>Model</th>
                            <th>Ranking model</th>
                            <th>No. predictions</th>
                            <th>No. matches</th>
                        </tr>
                    </thead>
                    <tbody id="cnn-states-tbody"></tbody>
                </table>
            </div>
            <div class="entity-table" style="width:20%;order:2;">
                <div>Target user:</div>
                <table>
                    <thead>
                        <tr><th></th><th>Name</th></tr>
                    </thead>
                    <tbody id="target-users"></tbody>
                </table>
            </div>
        </div>

        <div id="threshold-control" style="display:none;margin-top:5px;">
            <span>Distance/IoU threshold:</span>
            <input type="range" id="threshold-range" min="0.0" max="1.0" step="0.01" value="0.5" />
            <input type="number" id="threshold-number" min="0.0" max="1.0" step="0.01" value="0.5" style="width:60px" />
        </div>

        <div style="margin-top:5px;margin-bottom:5px;">
            <input type="checkbox" id="check-golden-question-only" value="goldenQuestionsOnly" />
            <label for="check-golden-question-only">Limit to golden questions only</label>
        </div>

        <button id="calc-stats" class="btn btn-sm btn-primary">Update</button>
    </div>

    <div style="margin-top:20px">
        <h2>Performance</h2>
        <div id="performance-container"></div>
    </div>
</div>
<link rel="stylesheet" href="/static/statistics/libs/chartjs/Chart.min.css" />
<style>
    #options-container {
        margin-bottom: 5px;
    }

    .tables-container {
        display: flex;
        flex-direction: row;
    }

    .entity-table {
        margin: 10px;
        width: 50%;
    }

    table {
        width: 100%;
        height: 90%;
        max-height: 90%;
        border: 1px solid #aaa;
    }

    thead {
        background: #5f5f5f;
        font-weight: bold;
    }

    tbody {
        overflow-x: hidden;
        overflow-y: auto;
        max-height: 200px;
    }

    thead, tbody {
        display: block;
        padding-left: 5px;
        padding-right: 5px;
    }

    td, th {
        padding-right: 5px;
    }

    .chartWrapper {
        position: relative;
    }

    .chartWrapper > canvas {
        position: absolute;
        left: 0;
        top: 0;
        pointer-events:none;
    }

    .chartAreaWrapper {
        width: 100%;
        height: 300px;
        max-height: 300px;
        overflow-x: scroll;
    }
</style>
<script src="/static/statistics/libs/chartjs/Chart.min.js"></script>
<script type="text/javascript">
    $(document).ready(function() {

        // get project annotation and prediction types
        var promise = $.ajax({
            url: 'getProjectSettings',
            method: 'GET',
            success: function(data) {
                window.annotationType = data['settings']['annotationType'];
                window.predictionType = data['settings']['predictionType'];

                // show advanced controls for points & bounding boxes
                if(window.annotationType === 'points' || window.annotationType === 'boundingBoxes') {
                    $('#threshold-control').show();
                }
            },
            error: function(data) {
                console.log('ERROR:')
                console.log(data);
            }
        });

        // get all model states
        let modelStateTable = $('#cnn-states-tbody');
        promise = promise.then(function() {
            return $.ajax({
                url: 'listModelStates',
                method: 'GET',
                success: function(data) {
                    if(data.hasOwnProperty('modelStates')) {
                        data = data['modelStates'];
                        for(var i=0; i<data.length; i++) {
                            // construct model state markup
                            var markup = $('<tr></tr>');
                            markup.append($('<td><input type="checkbox" id="'+data[i]['id']+'" checked /></td>'));
                            markup.append($('<td>' + (data.length-i) + '</td>'));
                            markup.append($('<td>'+new Date(data[i]['time_created'] * 1000).toLocaleString()+'</td>'));
                            markup.append($('<td>'+data[i]['model_library']['name']+'</td>'));
                            markup.append($('<td>'+data[i]['al_criterion_library']['name']+'</td>'));
                            markup.append($('<td>'+data[i]['num_pred']+'</td>'));
                            markup.append($('<td class="num-matches"></td>'));  // populated upon query
                            modelStateTable.append(markup);
                        }
                    }
                },
                error: function(data) {
                    console.error(data);
                }
            });
        });

        // populate users tables
        let targetUsersTable = $('#target-users');
        promise = promise.then(function() {
            return $.ajax({
                url: 'getUserNames',
                method: 'POST',
                success: function(data) {
                    data = data['users'];
                    for(var idx in data) {
                        var tableEntry_target = $('<tr></tr>');
                        tableEntry_target.append($('<td><input type="radio" id="'+data[idx]+'" name="targetUser"></td>'))
                        tableEntry_target.append($('<td>'+data[idx]+'</td>'));
                        if(data[idx] === window.user) {
                            tableEntry_target.find('input[type=radio]').prop('checked', 'checked');
                        }
                        targetUsersTable.append(tableEntry_target);
                    }
                },
                error: function(data) {
                    console.log('ERROR:');
                    console.log(data);
                }
            });
        });

        // get all users
        promise = promise.then(function() {
            return $.ajax({

            });
        });


        promise = promise.done(function() {

            $('#select-all-states').click(function() {
                var checked = $(this).prop('checked');
                $.each($('#cnn-states-tbody').find('input[type=checkbox]'), function() {
                    $(this).prop('checked', checked);
                });
            });

            window.showLoadingOverlay(false);
        });
    });
</script>