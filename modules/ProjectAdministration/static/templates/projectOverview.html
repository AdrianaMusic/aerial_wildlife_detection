<!doctype html>
<html lang="en">
    <head>
        <title>AIde: {{ projectTitle }}</title>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous" />
        <link rel="stylesheet" href="{{ projectShortname }}/static/css/interface.css" />
        <link rel="stylesheet" href="{{ projectShortname }}/config/static/css/config-page.css" />
        <link rel="stylesheet" href="{{ projectShortname }}/statistics/static/libs/chartjs/Chart.min.css" />
        <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
        <script src="https://unpkg.com/tooltip.js"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
        <script src="{{ projectShortname }}/statistics/static/libs/chartjs/Chart.min.js"></script>
        <script type="text/javascript">
            $(document).ready(function() {
                let mainContainer = $('#main-container');

                // TODO: only if admin
                $.ajax({
                    url: '{{ projectShortname }}/getProjectStatistics',
                    method: 'GET',
                    success: function(response) {
                        response = response['statistics'];

                        var statsContainer = $('<div></div>');
                        statsContainer.append($('<h2>Progress</h2>'));

                        // general progress
                        let generalCanvas = $('<canvas id="chart-general-progress" width="400px" height="300px"></canvas>');
                        statsContainer.append(generalCanvas);
                        var generalChart = new Chart(generalCanvas[0].getContext('2d'), {
                            type: 'pie',
                            data: {
                                labels: ['viewed', 'to be viewed'],
                                datasets: [{
                                    data: [response['num_viewed'], response['num_images']-response['num_viewed']],
                                    backgroundColor: [
                                        '#007bff',
                                        '#929292'
                                    ]
                                }]
                            }
                        });

                        // per-user statistics
                        if(response.hasOwnProperty('user_stats')) {
                            var usernames = [];
                            var numImgs_viewed = [];
                            var numAnnotations_made = [];
                            for(var user in response['user_stats']) {
                                usernames.push(user);
                                var numViewed = response['user_stats'][user]['num_viewed'];
                                if(numViewed === null) numViewed = 0;
                                var numAnno = response['user_stats'][user]['num_annotations'];
                                if(numAnno === null) numAnno = 0;
                                numImgs_viewed.push(numViewed);
                                numAnnotations_made.push(numAnno);
                            }

                            let perUser_numImgs = $('<canvas id="chart-user-imgs" width="400px" height="300px"></canvas>');
                            statsContainer.append(perUser_numImgs);
                            var userImgsChart = new Chart(perUser_numImgs[0].getContext('2d'), {
                                type: 'bar',
                                data: {
                                    labels: usernames,
                                    datasets: [{
                                        data: numImgs_viewed,
                                        backgroundColor: ['#007bff']
                                    }]
                                }
                            });

                            let perUser_numAnnos = $('<canvas id="chart-user-annos" width="400px" height="300px"></canvas>');
                            statsContainer.append(perUser_numAnnos);
                            var userAnnosChart = new Chart(perUser_numAnnos[0].getContext('2d'), {
                                type: 'bar',
                                data: {
                                    labels: usernames,
                                    datasets: [{
                                        data: numAnnotations_made,
                                        backgroundColor: ['#007bff']
                                    }]
                                }
                            });
                        }


                        mainContainer.append(statsContainer);
                    },
                    error: function(data) {
                        console.log('ERROR:');
                        console.log(data);
                    }
                });
            });
        </script>
    </head>

    <body>
        <!-- Page Content -->
        <div id="page-container">
            <div id="content-wrapper">
                <!-- Overlay -->
                <div id="overlay" class="overlay">
                    <div id="overlay-card" class="overlay-card card container"></div>
                    <div id="overlay-loader">
                        <div style="text-align:center;margin-bottom:20px;font-size:20px;text-align:center;">Loading...</div>
                        <!-- blatant copy of MS azure's splash screen loading dots -->
                        <div class="azure-loadingdots">
                            <div></div>
                            <div></div>
                            <div></div>
                            <div></div>
                            <div></div>
                        </div>
                    </div>
                </div>

                <!-- Navigation bar -->
                <nav class="navbar navbar-expand-lg navbar-light bg-dark border-bottom">
                    <ul class="nav navbar-nav">
                        <li class="nav-item header-text">
                            <h1><a href="/">Projects</a> / <a href="/{{ projectShortnameÂ }}">{{ projectTitle }}</a></h1>
                        </li>
                    </ul>
                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item dropdown float-right">
                            <div class="dropdown nav navbar-nav" style="float:right;">
                                <a class="dropdown-toggle btn" id="navbar-user-dropdown" data-toggle="dropdown" href="#" style="color:white;font-weight:bold;" >{{ username }}</a>
                                <ul class="dropdown-menu" role="menu" aria-labelledby="navbar-user-dropdown">
                                    <li class="dropdown-item"><a id="logout" href="logout" class="btn btn-sm btn-danger">Log Out</a></li>
                                </ul>
                            </div>
                        </li>
                    </ul>
                </nav>
                <div class="grad-border-h"></div>

                <div class="main-container" id="main-container">
                </div>
            </div>

            <footer class="page-footer" id="footer">
                <div class="ms-logo">
                    <a href="about"><img height="100%" src="static/img/ms_logo.png" /></a>
                </div>
            </footer>
        </div>
    </body>
</html>